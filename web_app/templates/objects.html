{% extends "base.html" %}
{% block content %}
<div class="container">
    <h1>Добавить точку</h1>
    <button class="btn" id="addPointBtn">Добавить точку</button>

    <!-- Modal Structure -->
    <div class="modal" id="addPointModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Добавить точку</h2>
            <form class="compact-form" id="addPointForm">
                <label for="login">Логин:</label>
                <input id="login" name="login" required type="text"><br>

                <label for="address">Адрес:</label>
                <input id="address" name="address" required type="text"><br>

                <label for="phone">Рабочий телефон:</label>
                <input id="phone" name="phone" required type="text"><br>

                <label for="entity_id">Наименование компании:</label>
                <select id="entity_id" name="entity_id" required>
                    <!-- Options will be populated by JavaScript -->
                </select><br>

                <button id="submitPointBtn" type="button">Добавить</button>
            </form>
        </div>
    </div>

    <h2>Список точек</h2>
    <table border="1" id="objects_table">
        <thead>
        <tr>
            <th>ID</th>
            <th>Рабочий телефон</th>
            <th>Адрес</th>
            <th>Компания</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody>
        {% for object in objects %}
        <tr data-id="{{ object.id }}">
            <td><a href="{{ url_for('object_orders', object_id=object.id) }}" title="Заявки с этой точки">{{ object.id
                }}</a></td>
            <td>{{ object.phone }}</td>
            <td>{{ object.address }}</td>
            <td>{{ object.entity_id.name }}</td>
            <td>
                <div class="action-buttons">
                    <form action="{{ url_for('update_object', login=object.login) }}" method="get"
                          style="display:inline;">
                        <button class="changeObjectBtn" type="submit">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="deleteObjectBtn">
                            <i class="fa fa-trash"></i> <!-- Иконка мусорной корзины -->
                        </button>
                    </form>
                </div>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // DataTables инициализация
        $('#objects_table').DataTable({
            language: {
                "url": "https://cdn.datatables.net/plug-ins/1.10.21/i18n/Russian.json"  // Подключение русского перевода
            },// Отключить поиск
            paging: false,     // Отключить пагинацию
            info: false,       // Отключить информацию о таблице
            lengthChange: false,
            responsive: true,
            order: [],

        });

        var modal = document.getElementById('addPointModal');
        var btn = document.getElementById('addPointBtn');
        var span = document.getElementsByClassName('close')[0];

        btn.onclick = function () {
            modal.style.display = 'block';
        }

        span.onclick = function () {
            modal.style.display = 'none';
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        $('#submitPointBtn').click(function () {
            var formData = $('#addPointForm').serialize();
            $.ajax({
                type: 'POST',
                url: '{{ url_for("add_object") }}',
                data: formData,
                success: function (response) {
                    alert('Точка успешно добавлена');
                    modal.style.display = 'none';
                    location.reload();
                },
                error: function (response) {
                    alert('Ошибка при добавлении точки');
                }
            });
        });

        fetchEntities();

        // Обработчик клика по кнопке редактирования
        $(document).on('click', '.editObjectBtn', function () {
            var row = $(this).closest('tr');
            var objectId = row.data('id');
            // Перенаправление на страницу редактирования объекта
            window.location.href = '{{ url_for("update_object", login="") }}' + objectId;
        });

        // Обработчик клика по кнопке удаления
        $(document).on('click', '.deleteObjectBtn', function () {
            var row = $(this).closest('tr');
            var objectId = row.data('id');

            if (confirm('Вы уверены, что хотите удалить эту точку?')) {
                $.ajax({
                    type: 'POST',
                    url: '{{ url_for("delete_object") }}', // Создайте этот маршрут в вашем приложении
                    data: {id: objectId},
                    success: function (response) {
                        alert('Точка успешно удалена');
                        row.remove();
                        location.reload();
                    },
                    error: function (response) {
                        alert('Ошибка при удалении точки');
                    }
                });
            }
        });
    });

    function fetchEntities() {
        $.get('{{ url_for("get_entities") }}', function (data) {
            populateSelect($('#entity_id'), data);
        });
    }

    function populateSelect(selectElement, data) {
        selectElement.empty();
        data.forEach(function (item) {
            selectElement.append(new Option(item.name, item.id));
        });
    }
</script>
{% endblock %}
